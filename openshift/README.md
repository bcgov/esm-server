# How to quickly deploy to an OpenShift project

- Request a set of Openshift projects (a typical set of projects is 'tools', 'dev', 'test', 'prod') for your new version of ESM on OpenShift from the CSI lab devops team via the Requests channel following this guide: https://pathfinder-faq-ocio-pathfinder-prod.pathfinder.gov.bc.ca/OCP/StartingANewProject.html
- Your new 'tools' project will house the Jenkins instance that will be responsible for promoting application images (via OpenShift ImageStreamTagS) across the other three environments 'dev', 'test', and 'prod'. Your 'tools' project is typically set up in the naming convention of "[your-project-namespace]-tools" where [your-project-namespace] is auto-generated by the CSI lab devops team.  In the existing esm-server project, the tools name used was "esm".  This was set using an old naming convention and one of the peculiarities of OpenShift is that once a project is named it cannot be renamed, which is why the lab now assigns random short strings as project name prefixes.
- Run the following command to get into the proper directory for the next commands.
```
cd ./openshift/templates/params
```
- In the ./templates/params directory, copy the Virtual Environment folder called 'VENV' into a new folder with the initials of your new project in the params directly.
- The files are named in the order that they will be run and will create builds in your tools project that are clearly named as belonging to this project and are in dependency order.

## Configuring to run your project deployment
- Run the following command to get into the proper directory for the next commands.
```
cd ./openshift/templates
```
- Edit the files admin-0-deploy-all.sh and admin-0-clean-all.sh and change the PARAMS_FOLDER setting to point to the new params folder you created in the previous steps.
- Edit the file admin-0.config and change the build project and deployment project lines to match the 'tools' and 'dev' projects that you have been assigned by the CSI lab devops team.  The pattern you will follow is you will recreate (build, teardown, build, teardown) your deployments in OpenShift multiple times until you feel it is what you want, then apply these to your other 'test' and 'prod' environments by changing the deployment project in the admin-0.config file once you have the 'dev' environment properly set up.
- Edit the file admin-2-admin-server-dc-on-env-dev.params and change the build project 'APP_IMAGE_NAMESPACE' and deployment project 'PROJECT_NAMESPACE' lines to your OpenShift 'tools' and 'dev' project names.

## Configuring to run your project deployment
- Run the following command to get into the proper directory for the next commands.
```
cd ./openshift/templates
```
- Run the previously configured deployment by running 
```
./admin-0-deploy-all.sh
```
- If the above deployment results in an incorrect deployment, you can revert it using 
```
./admin-0-clean-all.sh
```
- It is expected that you will deploy and clean multiple times until you are satisfied with the deployment.  Once you have a good deployment (see next step for details), you will not run clean command as this is a destructive full wipe of all data and application components.  We only do this during the setup phase.  Once we have users and data, we will never clean the project.
- Once your deployment has run, there is a known bug in the Minio deployment that we need to correct.  Open the target environment project in the OpenShift web GUI. Click on 'Overview'.  Expand the application you just created and click on the minio deployment.  On the right dropdown, choose 'Edit' and in the 'Edit Deployment Config' screen that appears, scroll down to the 'Images' section, 'Container' sub-section.  Check the 'Deploy images from an image stream tag' setting and in the 'Image Stream Tag' area, set the three dropdowns to 'openshift', 'minio', 'stable'.  The deployments should start up once the builds finish making the imagestreams.  You can go into the tools project and watch the builds complete, then see the pods spin up in the deployment environment.
- To check if your server is up and configured properly, in the OpenShift GUI for the deployment project, on the left nav, choose 'Applications' then 'Routes'.  You will see the route for the admin server there.  Click on the route endpoint and it will open in a new browser.


# How to configure a new CI/CD pipeline for ESM on OpenShift
## Jenkins pipeline setup
- Deploy a Jenkins instance with persistent storage into the esm project using the web gui
- Install the Promoted Builds Jenkins plugin
- Configure a job that has an OpenShift ImageStream Watcher as its SCM source and promotion states for each environment
- In each promotion configuration, tag the target build's image to the appropriate promotion level; this was done using a shell command because the OpenShift plugins do not appear to handle parameter subsitution inside promotions properly.
- Create an OpenShift project for each "environment" (e.g. DEV, TEST, PROD, DEMO, TRAIN); Exact names used were esm-dev, esm-test, esm-prod, esm-demo, esm-train
- Configure the access controls to allow the Jenkins instance to tag imagestreams in the environment projects, and to allow the environment projects to pull images from the esm project:
 
```
oc policy add-role-to-user system:image-puller system:serviceaccount:esm-<env-name>:default -n esm
oc policy add-role-to-user edit system:serviceaccount:esm:default -n esm-<env-name>
```
 
- Use the JSON files in this directory  and `oc` tool to create the necessary resources within each project:

```
oc process -f esm-environment-template.json -v NAME=esm-<env-name>,APPLICATION_DOMAIN=esm-<env-name>.pathfinder.bcgov,APP_IMAGE_NAMESPACE=esm,APP_DEPLOYMENT_TAG=<env-name> | oc create -f -
```

For example:

```
oc process -f esm-environment-template.json -v NAME=esm-prod,APPLICATION_DOMAIN=esm-prod.pathfinder.bcgov,APP_IMAGE_NAMESPACE=esm,APP_DEPLOYMENT_TAG=prod,DOCUMENT_VOLUME_CAPACITY=200Gi,DATABASE_VOLUME_CAPACITY=10Gi | oc create -f -
```

# ESM Environments

There are several environments set up for different purposes within OpenShift. They are available at the URLs below.

|Environment| URL |Notes|
|-----------|-----|-----|
|DEV|esm-dev.pathfinder.gov.bc.ca||
|TEST|esm-test.pathfinder.gov.bc.ca||
|PROD|projects.eao.gov.bc.ca|SiteMinder is enabled for this environment|
|DEMO|esm-demo.pathfinder.gov.bc.ca||
|TRAIN|esm-train.pathfinder.gov.bc.ca||



# How to access Jenkins for ESM

- Login to https://esm-jenkins-esm.pathfinder.gov.bc.ca with the username/password that was provided to you.

# How to access OpenShift for ESM

## Web UI
- Login to https://console.pathfinder.gov.bc.ca:8443; you'll be prompted for GitHub authorization.

## Command-line (```oc```) tools
- Download OpenShift [command line tools](https://github.com/openshift/origin/releases/download/v1.2.1/openshift-origin-client-tools-v1.2.1-5e723f6-mac.zip), unzip, and add ```oc``` to your PATH.  
- Copy command line login string from https://console.pathfinder.gov.bc.ca:8443/console/command-line.  It will look like ```oc login https://console.pathfinder.gov.bc.ca:8443 --token=xtyz123xtyz123xtyz123xtyz123```
- Paste the login string into a terminal session.  You are no authenticated against OpenShift and will be able to execute ```oc``` commands. ```oc -h``` provides a summary of available commands.

# Project contents

- The "esm" project contains the Jenkins instance and the other esm-* projects contain different "environments".  The names are self-explanatory.

# Data management operations

Document load (from legacy EPIC -> *new EPIC*)

```oc rsh <app-pod> bash -c 'cd scripts && MONGO_CONNECTION=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@${MONGODB_PORT_27017_TCP_ADDR}/esm DOWNLOADS_DIR=/uploads ./run.sh'```

Count documents

```oc rsh <mongo-pod> bash -c 'mongo -u ${MONGODB_USER} -p ${MONGODB_PASSWORD} --eval "printjson(db.documents.count())" esm'```

Connect to database as admin

```oc rsh <mongo-pod> 
mongo -u admin -p ${MONGODB_ADMIN_PASSWORD} admin
```

Drop database

- Connect as admin (see above)

```
use esm
db.dropDatabase()
```

# Background reading/Resources

[Free OpenShift book](https://www.openshift.com/promotions/for-developers.html) from RedHat â€“ good overview

[Red Hat Container Development Kit](http://developers.redhat.com/products/cdk/overview/)

OpenShift CI/CD pieline Demos:

- https://www.youtube.com/watch?v=65BnTLcDAJI
- https://www.youtube.com/watch?v=wSFyg6Etwx8


Transport endpoint is not connected healthcheck solution:

As soon as the volume 'goes away' your application will also be torn down 
and unavailable until such time as the glusterFS/NFS/Remote mount comes back.  
This is because the healthcheck once failed with kill the pod(s).  This may or 
may not be desirable based on your individual application behaviors.

Liveness snippet to put in your deployment config:
    livenessProbe:
    exec:
      command: [sh, /opt/app-root/src/scripts/mount_test.sh]
    initialDelaySeconds: 10
    timeoutSeconds: 5
    periodSeconds: 60
    successThreshold: 1
    failureThreshold: 3


Mount detection script:

https://github.com/bcgov/esm-server/blob/develop/scripts/mount_test.sh



Environment Variables:

MOUNT_POINT_CHECK=/remote/dir

MOUNT_POINT_TIMEOUT=seconds
  

   
